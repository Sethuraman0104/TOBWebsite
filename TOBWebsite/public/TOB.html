<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top Stories Carousel â€“ Live Jungled Collage</title>

<!-- Owl Carousel CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">

<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background:#f5f5f5; }

#topStoriesCarousel { width: 100%; max-width: 1000px; margin:auto; position:relative; }
#topStoriesCarousel .item { position: relative; width: 100%; height: 500px; }

.collage-grid { display: grid; width: 100%; height: 100%; gap: 2px; }
.collage-item { overflow:hidden; }
.collage-item img { width:100%; height:100%; object-fit:cover; display:block; }

/* Overlay */
.carousel-category { position:absolute; top:10px; left:10px; background:#e63946; color:#fff; padding:5px 10px; border-radius:6px; font-weight:600; z-index:5; }
.carousel-overlay { position:absolute; bottom:15px; left:15px; background: rgba(0,0,0,0.6); color:#fff; padding:12px; border-radius:8px; max-width:90%; z-index:5; }
.carousel-title { font-size:1.3rem; font-weight:700; margin:5px 0; }

#topStoriesCarousel .owl-dots { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:6px; z-index:10; }
#topStoriesCarousel .owl-dot { width:12px; height:12px; border-radius:50%; background: rgba(255,255,255,0.6); transition: all 0.3s; }
#topStoriesCarousel .owl-dot.active { background:#e63946; transform: scale(1.2); }

</style>
</head>
<body>

<section>
  <div id="topStoriesCarousel" class="owl-carousel owl-theme"></div>
</section>

<!-- jQuery & Owl Carousel JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

<script>
function formatDateTime(dt){
    const d = new Date(dt);
    return d.toLocaleString();
}

async function loadTopStories(){
    try {
        const res = await fetch('/api/news/admin', { cache:'no-store' });
        const news = await res.json();
        const activeNews = (Array.isArray(news)?news:[])
            .filter(n => n.IsActive && n.IsApproved && n.IsTopStory==1);
        if(!activeNews.length) return;

        const carousel = document.getElementById('topStoriesCarousel');
        carousel.innerHTML = '';

        activeNews.forEach(n=>{
            let images = Array.isArray(n.ImagesURLs)?n.ImagesURLs:[];
            if(n.ImageURL && !images.includes(n.ImageURL)) images.unshift(n.ImageURL);
            images = images.filter(Boolean).slice(0,5); // 1-5 images

            // Dynamically assign grid layout based on image count
            let gridTemplate;
            switch(images.length){
                case 1: gridTemplate = 'grid-template-columns:1fr; grid-template-rows:1fr;'; break;
                case 2: gridTemplate = 'grid-template-columns:1fr 1fr; grid-template-rows:1fr;'; break;
                case 3: gridTemplate = 'grid-template-columns:2fr 1fr; grid-template-rows:1fr 1fr;'; break;
                case 4: gridTemplate = 'grid-template-columns:2fr 1fr; grid-template-rows:1fr 1fr;'; break;
                default: gridTemplate = 'grid-template-columns:2fr 1fr 1fr; grid-template-rows:2fr 1fr;'; break;
            }

            let collageHtml = `<div class="collage-grid" style="${gridTemplate}">`;
            images.forEach((img,index)=>{
                collageHtml += `<div class="collage-item collage-item-${index+1}">
                    <img src="${img}" alt="${n.Title}" onerror="this.src='/images/default-news.png'">
                </div>`;
            });
            collageHtml += `</div>`;

            const category = n.CategoryName || 'General';
            const published = formatDateTime(n.PublishedOn);

            carousel.innerHTML += `
            <div class="item">
                ${collageHtml}
                <div class="carousel-category">${category}</div>
                <div class="carousel-overlay">
                    <div class="carousel-date">ðŸ“… ${published}</div>
                    <h3 class="carousel-title">${n.Title}</h3>
                    <p>${n.Summary || ''}</p>
                    <button class="btn read-more-btn" onclick="openArticle(${n.ArticleID})">Read More</button>
                </div>
            </div>
            `;
        });

        // Destroy previous carousel if exists
        try{ $('#topStoriesCarousel').owlCarousel('destroy'); }catch(e){}
        // Initialize Owl Carousel
        $('#topStoriesCarousel').owlCarousel({
            items:1,
            loop:true,
            autoplay:true,
            autoplayTimeout:5000,
            smartSpeed:800,
            dots:true,
            nav:false
        });

    } catch(err){
        console.error('Error loading top stories:', err);
    }
}

window.addEventListener('load', loadTopStories);

function openArticle(id){
    alert("Open article ID: "+id);
}
</script>

</body>
</html>
